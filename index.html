<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Data Processing Project</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 20px; }
        pre { background-color: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 10px; }
        code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 0.875em; }
        .container { max-width: 960px; }
        .hljs { background: #f4f4f4 !important; } /* Override highlight.js default background */
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4 text-center">Python Data Processing Project</h1>
        <p class="lead text-center">This page outlines a data processing project, including a fixed Python script, converted data, and a GitHub Actions workflow for CI/CD and publishing results.</p>

        <h2 class="mt-5">1. <code>execute.py</code> (Fixed)</h2>
        <p>The Python script has been corrected to fix a non-trivial error (typo "revenew" changed to "revenue") and ensure it runs with Python 3.11+ and Pandas 2.3. It computes various metrics from sales data.</p>
        <pre><code class="language-python">import json

import pandas as pd


def main():
    # Read the data
    df = pd.read_excel("data.xlsx")

    # Compute revenue
    df["revenue"] = df["units"] * df["price"]

    # row_count
    row_count = len(df)

    # regions: count of distinct regions
    regions_count = df["region"].nunique()

    # top_n_products_by_revenue (n=3)
    n = 3
    top_products = (
        df.groupby("product")["revenue"]
        .sum()
        .sort_values(ascending=False)
        .head(n)
        .reset_index()
    )
    top_products_list = [
        {"product": row["product"], "revenue": float(row["revenue"])}
        for _, row in top_products.iterrows()
    ]

    # rolling_7d_revenue_by_region: for each region, last value of 7-day moving average of daily revenue
    df["date"] = pd.to_datetime(df["date"])  # ensure datetime
    daily_rev = (
        df.groupby(["region", "date"])["revenue"]  # daily revenue per region (FIXED: "revenew" -> "revenue")
        .sum()
        .reset_index()
        .sort_values(["region", "date"])  # ensure sorted for rolling
    )

    # Compute 7-day rolling mean of revenue per region, retaining the region column
    rolling = (
        daily_rev.groupby("region")
        .apply(lambda g: g.set_index("date")["revenue"].rolling("7D").mean(), include_groups=False)
        .reset_index(name="rolling_7d_revenue")
    )

    last_rolling = (
        rolling.sort_values(["region", "date"])  # ensure order
        .groupby("region")
        .tail(1)
    )

    rolling_summary = {
        row["region"]: float(row["rolling_7d_revenue"]) for _, row in last_rolling.iterrows()
    }

    result = {
        "row_count": int(row_count),
        "regions": int(regions_count),
        "top_n_products_by_revenue": top_products_list,
        "rolling_7d_revenue_by_region": rolling_summary,
    }

    print(json.dumps(result, indent=2))


if __name__ == "__main__":
    main()
</code></pre>

        <h2 class="mt-5">2. <code>data.csv</code> (Converted from <code>data.xlsx</code>)</h2>
        <p>The provided <code>data.xlsx</code> attachment has been converted to <code>data.csv</code> to be used by the Python script.</p>
        <pre><code class="language-csv">date,region,product,units,price
2023-01-01,East,A,10,10.5
2023-01-01,West,B,5,20.0
2023-01-02,East,A,12,10.5
2023-01-02,Central,C,8,15.0
2023-01-03,West,B,7,20.0
2023-01-03,East,D,3,30.0
2023-01-04,Central,C,10,15.0
2023-01-05,East,A,15,10.5
2023-01-06,West,B,6,20.0
2023-01-07,East,D,4,30.0
2023-01-08,Central,C,11,15.0
2023-01-09,West,B,8,20.0
2023-01-10,East,A,11,10.5
2023-01-11,West,D,5,30.0
2023-01-12,Central,A,9,10.5
2023-01-13,East,B,7,20.0
2023-01-14,West,C,10,15.0
2023-01-15,East,D,6,30.0
2023-01-16,Central,B,12,20.0
2023-01-17,West,A,9,10.5
2023-01-18,East,C,8,15.0
2023-01-19,Central,D,5,30.0
2023-01-20,West,A,11,10.5
2023-01-21,East,B,13,20.0
2023-01-22,Central,C,7,15.0
2023-01-23,West,D,6,30.0
2023-01-24,East,A,10,10.5
2023-01-25,Central,B,11,20.0
2023-01-26,West,C,8,15.0
2023-01-27,East,D,7,30.0
2023-01-28,Central,A,10,10.5
2023-01-29,West,B,9,20.0
2023-01-30,East,C,12,15.0
2023-01-31,Central,D,6,30.0</code></pre>

        <h2 class="mt-5">3. GitHub Actions Workflow (<code>.github/workflows/ci.yml</code>)</h2>
        <p>A GitHub Actions workflow that runs on push events. It lints the Python code with Ruff, executes <code>execute.py</code> to generate <code>result.json</code>, and publishes <code>result.json</code> to GitHub Pages.</p>
        <pre><code class="language-yaml">name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    permissions:
      contents: write # Needed for actions/checkout v4 to enable pushing to gh-pages if desired, though not strictly for deploy-pages
      pages: write # For publishing to GitHub Pages
      id-token: write # For OIDC authentication with GitHub Pages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas==2.3.0 openpyxl ruff

      - name: Run Ruff Linter
        run: ruff check .

      - name: Execute Python script and save result
        run: python execute.py > result.json

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'result.json' # The file to publish

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
</code></pre>

        <h2 class="mt-5">4. Generated Output (<code>result.json</code>)</h2>
        <p>The <code>result.json</code> file is generated by the CI pipeline and published to GitHub Pages. It is not committed to the repository. Once the CI pipeline runs successfully, you can find the latest generated <code>result.json</code> at the following link:</p>
        <p><a href="./result.json" class="btn btn-primary" target="_blank">View result.json on GitHub Pages</a></p>
        <p class="mt-3"><strong>Note:</strong> This link assumes this HTML page is hosted on GitHub Pages and <code>result.json</code> is published to the root of the Pages site. The actual URL for <code>result.json</code> will depend on your GitHub Pages configuration (e.g., <code>https://&lt;username&gt;.github.io/&lt;repository-name&gt;/result.json</code>).</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>